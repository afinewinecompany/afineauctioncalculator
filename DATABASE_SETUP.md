# Database Setup Guide

This guide covers setting up PostgreSQL for the Fantasy Baseball Auction Tool in development and production environments.

## Quick Start (Development)

### 1. Install Dependencies

```bash
npm install prisma @prisma/client dotenv
```

### 2. Set Up Environment Variables

Copy `.env.example` to `.env`:

```bash
cp .env.example .env
```

Edit `.env` and configure your database connection:

```env
DATABASE_URL="postgresql://user:password@localhost:5432/fantasy_auction?schema=public"
```

### 3. Initialize Prisma (if not already done)

```bash
npx prisma init
```

This creates the `prisma/schema.prisma` file (already created in this project).

### 4. Run Database Migrations

```bash
# Create and apply migrations
npx prisma migrate dev --name init

# This will:
# 1. Create a new migration file
# 2. Apply it to your database
# 3. Generate the Prisma Client
```

### 5. (Optional) Seed the Database

Create a seed script to populate initial data:

```bash
npx prisma db seed
```

### 6. View Database in Prisma Studio

```bash
npx prisma studio
```

Opens a GUI at http://localhost:5555 to browse and edit your database.

---

## Database Options

### Option 1: Local PostgreSQL (Development)

**Install PostgreSQL:**

- **macOS:** `brew install postgresql@15`
- **Windows:** Download from [postgresql.org](https://www.postgresql.org/download/)
- **Linux:** `sudo apt-get install postgresql`

**Start PostgreSQL:**

```bash
# macOS
brew services start postgresql@15

# Linux
sudo service postgresql start
```

**Create Database:**

```bash
# Connect to PostgreSQL
psql postgres

# Create database and user
CREATE DATABASE fantasy_auction;
CREATE USER fantasy_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE fantasy_auction TO fantasy_user;
\q
```

**Connection String:**

```
DATABASE_URL="postgresql://fantasy_user:your_password@localhost:5432/fantasy_auction?schema=public"
```

---

### Option 2: Docker PostgreSQL (Development)

**Create `docker-compose.yml`:**

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: fantasy_auction_db
    environment:
      POSTGRES_USER: fantasy_user
      POSTGRES_PASSWORD: fantasy_password
      POSTGRES_DB: fantasy_auction
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: fantasy_auction_redis
    ports:
      - '6379:6379'

volumes:
  postgres_data:
```

**Start Services:**

```bash
docker-compose up -d
```

**Connection String:**

```
DATABASE_URL="postgresql://fantasy_user:fantasy_password@localhost:5432/fantasy_auction?schema=public"
REDIS_URL="redis://localhost:6379"
```

---

### Option 3: Railway (Production/Staging)

**Benefits:**

- Managed PostgreSQL with automatic backups
- Integrated Redis
- Environment variables auto-injected
- Private networking between services

**Setup:**

1. Create a Railway account at [railway.app](https://railway.app)
2. Create a new project
3. Add PostgreSQL plugin
4. Add Redis plugin (optional)
5. Copy `DATABASE_URL` from Railway dashboard to your `.env`

**Connection String (auto-generated by Railway):**

```
DATABASE_URL="postgresql://user:password@containers-us-west-123.railway.app:5432/railway"
REDIS_URL="redis://default:password@containers-us-west-123.railway.app:6379"
```

---

### Option 4: Supabase (Production Alternative)

1. Create project at [supabase.com](https://supabase.com)
2. Go to Project Settings â†’ Database
3. Copy connection string (Direct Connection, not Pooler)

**Connection String:**

```
DATABASE_URL="postgresql://postgres.xyz:password@aws-0-us-west-1.pooler.supabase.com:5432/postgres"
```

---

## Database Schema Overview

### Users & Authentication

- **users** - User accounts with email/OAuth authentication
- **refresh_tokens** - JWT refresh tokens for session management

### Leagues

- **leagues** - League configuration (scoring, roster, dynasty settings)
- **user_leagues** - User membership in leagues (many-to-many)

### Players & Projections

- **players** - Master player list with external IDs
- **player_projections** - Projection stats per system (Steamer, JA, etc.)

### Draft State

- **league_players** - Player status per league (available/drafted/on_block)
- **draft_picks** - Historical record of all draft picks

---

## Common Prisma Commands

### Migrations

```bash
# Create a new migration
npx prisma migrate dev --name <migration_name>

# Apply migrations (production)
npx prisma migrate deploy

# Reset database (WARNING: deletes all data)
npx prisma migrate reset

# View migration status
npx prisma migrate status
```

### Schema Updates

```bash
# Generate Prisma Client after schema changes
npx prisma generate

# Format schema file
npx prisma format

# Validate schema
npx prisma validate
```

### Database Inspection

```bash
# Pull schema from existing database
npx prisma db pull

# Push schema changes without creating migrations (dev only)
npx prisma db push

# Open Prisma Studio (database GUI)
npx prisma studio
```

---

## Environment Variables Reference

### Required

```env
DATABASE_URL="postgresql://..."      # PostgreSQL connection string
JWT_SECRET="min-32-chars"            # JWT signing secret
JWT_REFRESH_SECRET="min-32-chars"   # Refresh token secret
NODE_ENV="development"               # Environment mode
PORT="3001"                          # Server port
FRONTEND_URL="http://localhost:3000" # Frontend URL for CORS
CORS_ORIGINS="http://localhost:3000" # Allowed origins
```

### Optional

```env
REDIS_URL="redis://..."              # Redis connection (optional)
GOOGLE_CLIENT_ID=""                  # Google OAuth
GOOGLE_CLIENT_SECRET=""              # Google OAuth
LOG_LEVEL="info"                     # Logging level
```

---

## Troubleshooting

### Connection Errors

**Error:** `Can't reach database server`

- Check PostgreSQL is running: `pg_isready`
- Verify connection string format
- Check firewall/network settings
- For Docker: `docker-compose ps`

### Migration Errors

**Error:** `Migration failed to apply`

- Check database schema manually
- Reset database: `npx prisma migrate reset`
- Check for conflicting schema changes

### Permission Errors

**Error:** `permission denied for database`

```sql
GRANT ALL PRIVILEGES ON DATABASE fantasy_auction TO fantasy_user;
GRANT ALL PRIVILEGES ON SCHEMA public TO fantasy_user;
```

### SSL Errors (Production)

Add `?sslmode=require` to connection string:

```
DATABASE_URL="postgresql://user:password@host:5432/db?sslmode=require"
```

---

## Production Deployment Checklist

### Pre-Deployment

- [ ] All migrations tested locally
- [ ] `.env.example` updated with new variables
- [ ] Database backups configured
- [ ] SSL/TLS enabled for database connections
- [ ] Connection pooling configured (Prisma default: 10 connections)

### Deployment

```bash
# 1. Set DATABASE_URL environment variable
export DATABASE_URL="postgresql://..."

# 2. Run migrations (non-interactive)
npx prisma migrate deploy

# 3. Generate Prisma Client
npx prisma generate

# 4. Start server
npm run start:backend
```

### Post-Deployment

- [ ] Health check returns 200: `GET /api/health`
- [ ] Database connection verified
- [ ] Monitor error logs for database issues
- [ ] Check connection pool usage

---

## Security Best Practices

### Environment Variables

- **Never commit `.env` to git** (already in `.gitignore`)
- Use separate databases for dev/staging/prod
- Rotate JWT secrets regularly
- Use strong passwords (min 16 characters)

### Database Access

- Use least-privilege database users
- Enable SSL/TLS in production
- Whitelist IP addresses (if supported by host)
- Monitor for suspicious queries

### Prisma Security

- Parameterized queries (automatic with Prisma)
- Input validation with Zod before database calls
- No raw SQL injection vectors (use `$queryRaw` with parameters)

---

## Next Steps

After database setup:

1. **Phase 1.3:** Implement authentication endpoints (`POST /api/auth/register`, etc.)
2. **Phase 1.4:** Add security hardening (rate limiting, helmet, sanitization)
3. **Phase 2.1:** Separate frontend/backend deployments
4. **Phase 2.2:** Add Redis caching layer

See [docs/PRODUCTION_ROADMAP.md](./docs/PRODUCTION_ROADMAP.md) for full implementation plan.
